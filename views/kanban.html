<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
	<link href="/css/jquery-ui.min.css" rel="stylesheet">
	<link href="/css/jquery-ui.css" rel="stylesheet">
	<link href="/css/bootstrap.min.css" rel="stylesheet" >
    <link href="/css/bootstrap.css" rel="stylesheet" >
    <script src="/js/jquery-2.1.4.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/socket.io-1.3.6.js"></script>
	<style type="text/css">
		.tdBorder{border-left:WhiteSmoke 2px solid;width: 200px;height:570px;}
		.tdBorderTitle{border-left:WhiteSmoke 2px solid;border-bottom:WhiteSmoke 2px solid;}
		.tdBorderLast{border-left:WhiteSmoke 2px solid;}
		div#process {padding-top:60px}
		label {
			display: inline-block;
			width: 5em;
		}

	/* Clearfix for the menu */
	.ui-menu:after {
		content: ".";
		display: block;
		clear: both;
		visibility: hidden;
		line-height: 0;
		height: 0;
	}

	.ui-menu .ui-menu-item {
		display: inline-block;
		float: left;
		margin: 5;
		padding: 5;
		width: auto;
	}
	</style>



	<script src="/js/angular.min.js"></script>
	<link rel="stylesheet" href="/css/task_style.css" media="all">

	<script>
	jQuery(document).ready(function($) {
		$('#btn_add_task').click(function(){
			clearInputTemp();
			$('#add_edit_task_lable').html('Add task');
			$('#btn_add').val('Add');
			$('#btn_add').attr("ng-click","add()");

			$('.theme-popover-mask').fadeIn(100);
			$('.theme-popover').slideDown(200);
		})
		$('.theme-poptit .close').click(function(){
			$('.theme-popover-mask').fadeOut(100);
			$('.theme-popover').slideUp(200);
		})

	})
	</script>

    <title>Watson Kanban</title>
</head>

<body>
    
    <div id = "logo-container">
		<div style="float:left; padding:2px;"><img src = "images/logo.jpg"></img></div>
		<div style="float:left; padding-top:16px; padding-left: 10px"><h3><%=current_progress_name %></h3></div>
	</div>
	<div id="process" class="panel panel-default" rev = "<%=rev %>">
		<div>
		<ul id="nav">
			<li><a class="btn theme-login" href="/">Process Management</a></li>
			<li><a class="btn theme-login" id="btn_add_task" href="javascript:;" hidden>Add Task</a></li>
			<li><a class="btn theme-login" href="/logout">Logout</a></li>
		</ul>
		</div>
		<table border = "0" align = "center" id = "kanbantable" width = "98%" height = "100%" class="table table-condensed table-responsive ">
			<% for (var i = 0; i<process.length;  i++) { %>
				<th>
					<div class = "processtitle" title = "<%=process[i].description %>">
						<%=process[i].status_name %>(<%=process[i].tasks.length%>)
						<% if(process[i].wip) { %>
							WIP(<%=process[i].wip %>)
						<% } %>
					</div>
				</th>
			<% } %>
			<tr>
				<% for (var i = 0; i<process.length;  i++) { %>
					<td width = "20%" class = 'tdBorder' id = "status_<%=process[i].status_id %>">
						<% 
						for (var j = 0; j<process[i].tasks.length;  j++) { %>
							<div id = "<%=process[i].tasks[j]%>"></div>
						<% } %>
					</td>
				<% } %>
			</tr>
		</table>
	</div>

<div class="theme-popover" style="display: none;">
     <div class="theme-poptit">
          <a href="javascript:;" title="Close" class="close">×</a>
          <h3 id="add_edit_task_lable">Add task</h3>
     </div>
     <div class="theme-popbod dform" ng-app="myApp" ng-controller="tasksCtrl">
		 
           <form class="theme-signin" action="" method="" novalidate name="taskForm">
                <ol>
                     <!--<li><h4>Enter task info.</h4></li>-->
					 <li>
						<input type="text" name="task_id" ng-model="task.task_id" required class="ipt" hidden>
						<input type="text" name="task_rev" ng-model="task.task_rev" required class="ipt" hidden>
						<strong class="control-label">Task Name<font color="red">(*)</font>:</strong>
						<input type="text" name="taskName" ng-model="task.taskName" required class="ipt">
						
						<span style="color:red" ng-show="taskForm.taskName.$dirty && taskForm.taskName.$invalid">
							<span ng-show="taskForm.taskName.$error.required">
								Required.
							</span>
						</span>
					 </li>
                     <li>
						<strong class="control-label">Task Type:</strong>
					 	<!--<input type="text" name="taskTypeID" ng-model="task.taskTypeID" required class="ipt">-->
						 <select name="taskTypeID" ng-model="task.taskTypeID" ng-options="x for x in taskTypeIDs" required class="ipt"></select>
						<!--<span style="color:red" ng-show="taskForm.taskTypeID.$dirty && taskForm.taskTypeID.$invalid">
							<span ng-show="taskForm.taskTypeID.$error.required">
								Task Type ID is blank.
							</span>
						</span>-->
					 </li>
                     <li>
						<strong class="control-label">System Name:</strong>
						<select name="systemName" ng-model="task.systemName" ng-options="x for x in systemNames" required class="ipt"></select>
					 	<!--<input type="text" name="systemName" ng-model="task.systemName" required class="ipt">-->
						<!--<span style="color:red" ng-show="taskForm.systemName.$dirty && taskForm.systemName.$invalid">
							<span ng-show="taskForm.systemName.$error.required">
								Task Type ID is blank.
							</span>
						</span>-->
					 </li>
                     <li>
						<strong class="control-label">Start Estimate:</strong>
					 	<input type="text" name="startEst" ng-model="task.startEst" required class="ipt">
						<!--<span style="color:red" ng-show="taskForm.startEst.$dirty && taskForm.startEst.$invalid">
							<span ng-show="taskForm.startEst.$error.required">
								Task id is blank.
							</span>
						</span>-->
					 </li>
					 <li>
						<strong class="control-label">Finish Estimate:</strong>
					 	<input type="text" name="finishEst" ng-model="task.finishEst" required class="ipt">
						<!--<span style="color:red" ng-show="taskForm.finishEst.$dirty && taskForm.finishEst.$invalid">
							<span ng-show="taskForm.finishEst.$error.required">
								Task id is blank.
							</span>
						</span>-->
					 </li>

					 <li>
						<strong class="control-label">Owner:</strong>
						<select name="owner" ng-model="task.owner" ng-options="x for x in owners" required class="ipt"></select>
						<!--<span style="color:red" ng-show="taskForm.owner.$dirty && taskForm.owner.$invalid">
							<span ng-show="taskForm.owner.$error.required">
								Task id is blank.
							</span>
						</span>-->
					 </li>

					 <li>
						<strong class="control-label">Approver:</strong>
						<select name="approver" ng-model="task.approver" ng-options="x for x in approvers" required class="ipt"></select>
						<!--<span style="color:red" ng-show="taskForm.approver.$dirty && taskForm.approver.$invalid">
							<span ng-show="taskForm.approver.$error.required">
								Task id is blank.
							</span>
						</span>-->
					 </li>
					 <li>
						<strong class="control-label">Total Work:</strong>
					 	
						 <select name="totalWork" ng-model="task.totalWork" ng-options="x for x in totalWorks" required class="ipt"></select>
						<!--<span style="color:red" ng-show="taskForm.totalWork.$dirty && taskForm.totalWork.$invalid">
							<span ng-show="taskForm.totalWork.$error.required">
								Task id is blank.
							</span>
						</span>-->
					 </li>
					 <!--<li>
						<strong>Remaining Work:</strong>
					 	<input type="text" name="remainingWork" ng-model="task.remainingWork" required class="ipt">
						<span style="color:red" ng-show="taskForm.remainingWork.$dirty && taskForm.remainingWork.$invalid">
							<span ng-show="taskForm.remainingWork.$error.required">
								Task id is blank.
							</span>
						</span>
					 </li>-->
					 <li>
						<strong class="control-label">Detail:</strong>
					 	<textarea name="detail" ng-model="task.detail" required rows="5" style="height:80px;" class="ipt"></textarea>
						<!--<span style="color:red" ng-show="taskForm.detail.$dirty && taskForm.detail.$invalid">
							<span ng-show="taskForm.detail.$error.required">
								Task id is blank.
							</span>
						</span>-->
					 </li>
                     <li>
						<span style="color:red;">(*) is required.</span>
						<input type="button" ng-click="reset()" class="btn btn-primary" style="margin-left: 30px;" value="Reset">
						<input id="btn_add" type="button" ng-click="add()" ng-disabled="taskForm.taskName.$invalid" class="btn btn-primary" value="Add">
					 </li>

                </ol>
           </form>

     </div>
</div>

<div id="error-message" title="Error occured." style="display: none;">
  <p>
	<b><div id = "err-message-content">Error.</div></b>
  </p>
</div>

<div class="theme-popover-mask" style="display: none;"></div>
<script src="/js/task.js"></script>

	<script type="text/javascript">
		var socket = io();	
		socket.on('messages', function(msgObj){
			if (msgObj._id==null || msgObj._id==undefined) {
			} else {
				refreshPage();
			}
		});
		function getSocket(){
			if(socket==null || socket==undefined){
				socket = io();
			}
			return socket;
		}

		function refreshPage() {
			setTimeout(function(){
				window.location.reload();
			},10000);	
		}

		$(".processtitle").tooltip();

		function deleteTask(currentObj) {
			var toDeleteTaskObj = {};
			var currentStatusTasks = new Array();
			var currentStatus;
			toDeleteTaskObj.process_rev = $('#process').attr("rev");
			toDeleteTaskObj.task_id = $(currentObj).parent().parent().parent().attr('id');
			toDeleteTaskObj.task_rev = $(currentObj).parent().parent().parent().attr('rev');
			currentStatus = $(currentObj).parent().parent().parent().parent();
			toDeleteTaskObj.current_status_id = currentStatus.attr('id');
			currentStatus.children().each(function(i,task) {
				if (toDeleteTaskObj.task_id != task.id) {
					currentStatusTasks.push(task.id);
				}
			});
			toDeleteTaskObj.current_status_tasks = currentStatusTasks.toString();
			//alert(JSON.stringify(toDeleteTaskObj));
			$.post(
				"/tasks/deletetask",
				toDeleteTaskObj,
				function(data,result) {
					window.location.reload();
				}
			);
			$(currentObj).parent().parent().parent().remove();
		}

		function clearInputTemp(){
			$("input[name='taskName']").val("");

			//TODO
		}

		function editTask(currentObj){

			clearInputTemp();
			$('#add_edit_task_lable').html('Edit task');
			$('#btn_add').val('Edit');
			$('#btn_add').attr("ng-click","edit()");
			$('.theme-popover-mask').fadeIn(100);
			$('.theme-popover').slideDown(200);

			//TODO: fetch detail from DB
				
			var toEditTaskObj = {};
			toEditTaskObj.process_rev = $('#process').attr("rev");
			toEditTaskObj.task_id = $(currentObj).parent().parent().parent().attr('id');
			toEditTaskObj.task_rev = $(currentObj).parent().parent().parent().attr('rev');

			$.getJSON(
				"/tasks/edittask",
				toEditTaskObj,
				function(data,status){
					if (data.status != '"NG"') {
						$("input[name='task_id']").val(data.task_id);
						$("input[name='task_rev']").val(data.task_rev);
						//$('#err-message-content').text(data.err);
						$("input[name='taskName']").val(data.task_name);
						// $("input[name='taskTypeID']").attr('value', 'string:' + data.task_type);
						// var count=$("input[name='taskTypeID']").length;
						// for(var i=0;i<count;i++) 
						// { if($("input[name='taskTypeID']").get(0).options[i].text === data.task_type) 
						// { 
						// $("input[name='taskTypeID']").get(0).options[i].selected = true; 
						// break; 
						// } 
						// }
						//alert(data.task_type);
						//alert($("input[name='taskTypeID'] option[label='" + data.task_type + "']").find("option:selected").text());
						//$("input[name='taskTypeID'] option[label='" + "Regular Operation" + "']").attr("selected", true);
						
						alert($("input[name='taskTypeID']").children("option"));
						$("input[name='taskTypeID'] option").find(":selected").text(data.task_type);
						// $("input[name='taskTypeID'] option").each(function(){
						// 	alert("****");
						// 	var temp_value = $(this).val();
						// 	alert("****");
						// 	alert(temp_value);
						// 	alert(data.task_type);
						// 	if(temp_value == data.task_type){
						// 		alert(temp_value);
						// 			$(this).attr("selected",true);
						// 	}
						// });


						// $("input[name='taskTypeID'] option[text=" + data.task_type + "]").attr("selected",true);
						$("input[name='startEst']").val(data.task_start_est);
						$("input[name='finishEst']").val(data.task_end_est);
						$("input[name='totalWork']").val(data.task_totaltime);
						//$("input[name='taskType']").val(data.task_remaintime);
						$("input[name='owner']").val(data.task_assignment);
						
					}

					
				}
			)

		}	

		$(document).ready(function(){
			$( "#nav" ).menu({position: {at: "left bottom"}});
			$( 'th' ).tooltip();
			var tasksjson ='<%-JSON.stringify(tasks) %>';
			var tasks = JSON.parse(tasksjson);
			var process = JSON.parse('<%-JSON.stringify(process) %>');
			$.each(tasks, function(index, content){
				var assignment = content.task_assignment;
				var priority = content.task_priority;
				var taskType = content.task_tasktype_id;
				if (typeof(assignment) == "undefined") {
					var assignment = "Unassigned";
				}
				var endtime_estimated = content.task_end_est;
				if (typeof(endtime_estimated) === "undefined") {
					var endtime_estimated = "";
				}
				if (priority === "A") {
					priority = "⭐️⭐️⭐️";
				} else {
					priority = "";
				}
				$( '#' + content._id ).replaceWith(""
					+"<div class='panel panel-primary' id = '" + content._id +"' rev = '" + content._rev +"'>"
					+"	<div class='panel-title'> <h6 >"
					+ "&nbsp;&nbsp;<a href = '#' class = 'taskdetail' title = '"
					+ "Task Type:" + content.task_type
					+ "&#13;Task Detail:" + content.task_detail
					+"'>Detail</a>&nbsp;&nbsp;&nbsp;"
					+"<a href = '#' onclick ='editTask(this)'>Edit</a>&nbsp;&nbsp;&nbsp;<a href = '#' onClick = 'deleteTask(this)'>Delete</a>"
					+"&nbsp;&nbsp;&nbsp;<font color = red>"+endtime_estimated + "</font>&nbsp;"
					+"</h6> </div>"
					+"	<div class='panel-body'><h5>"+content.task_name+"</h5></div>"
					+"	<div class='panel-footer'>"
					+ priority + "【" +assignment+ "】</div>"
					+"</div>");
					$('.panel-footer').css({"height":'40',"font-size":'16px',"color":'blue',"text-align":'right',"background-color":"white"});
					$('.panel-primary').css("width",'200');
					//$('.panel-primary').css("width",$(window).width()/process.length - 5);
					$(".panel-title").css({"background-color":"lavender","height":'30',"align":"center","padding-top":'8px'});
					$(".panel-primary").css("background-color","ivory");
					if (taskType === "emergency") {
						$(".panel-body").css({"background-color":"red","color":"white"});
					}
					$(".panel-primary").mouseover(function(){
					$(".panel-primary").css("cursor","pointer");
					$(".taskdetail").tooltip();
					});
			});
			
			var statusString = "'#status_1";
			 $.each(process, function(i,status){
				 if (status.status_id > 1){
					 statusString = statusString + ",#status_" + status.status_id;
				 }
			  });
			  statusString = statusString + "'"
			  var startstatus = null;
			  var endstatus = null;
			  var startTasksArray = new Array();
			  var endTasksArray = new Array();
			$( eval(statusString) ).sortable({
				connectWith: ".tdBorder",
				start: function( event, ui ) {
					startstatus = ui.item.parent();
				},
				stop: function( event, ui ) {
					startstatus.children().each(function(i,task) {
						startTasksArray.push(task.id);
					});
					endstatus = ui.item.parent();
					endstatus.children().each(function(i,task) {
						endTasksArray.push(task.id);
					});
					$.post(
						"./tasks",
						{"_id":ui.item.attr("id"),"task_status":ui.item.parent().attr("id"),
						 "start_status_id":startstatus.attr("id"),"end_status_id":endstatus.attr("id"),
						 "start_tasks":startTasksArray.toString(),"end_tasks":endTasksArray.toString(),
						 "rev":$('#process').attr("rev")},
						function(data,status) {
							if (JSON.stringify(data.err) != '"null"') {
								//$('#err-message-content').text(data.err);
								alert(data.err);
							}
							getSocket().emit('taskedit', {"_id":ui.item.attr("id"),"task_status":ui.item.parent().attr("id"),"rev":ui.item.attr("rev")});
						},
						"json"
					);
				},

			});
		   $( ".tdBorder" ).disableSelection();
		});
	</script>

</body>

</html>